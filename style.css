let balance = 200;
let freeSpins = 0;
let isSpinning = false;
let isAutoSpin = false;
let isFreeSpinActive = false;
let autoSpinInterval;
let missCount = 0;
const symbols = ["💰", "🎉", "⭐", "💎", "🎁", "🧧", "🎰"];
const SPIN_DELAY = 1500; // 1.5秒旋转动画
const STOP_DELAY = 500;  // 每个格子停止间隔

// 记录红包雨结果
let redPacketResults = {
    redPackets: 0,
    freeSpins: 0
};

window.addEventListener('load', () => {
    document.getElementById('spinButton').addEventListener('click', startSpin);
    document.getElementById('autoSpinButton').addEventListener('click', toggleAutoSpin);
});

// --- 核心修复逻辑 ---
function startFreeSpin() {
    if (freeSpins <= 0) {
        isFreeSpinActive = false;
        return;
    }

    isFreeSpinActive = true;
    startSpin(); // 开始旋转
    freeSpins--; // 每次旋转后减少次数
    document.getElementById('freespins').textContent = freeSpins;

    // 递归调用，直到免费旋转次数为0
    setTimeout(() => {
        if (freeSpins > 0) {
            startFreeSpin();
        } else {
            isFreeSpinActive = false;
        }
    }, SPIN_DELAY);
}

function checkWin(results, bet) {
    if (results[0] === results[1] && results[1] === results[2]) {
        const symbol = results[0];
        let winAmount = 0;

        switch (symbol) {
            case '🎁':
                if (isAutoSpin) stopAutoSpin();
                if (isFreeSpinActive) {
                    // 免费旋转中再次中奖：直接累加次数
                    const newFreeSpins = Math.floor(Math.random() * 5) + 1;
                    freeSpins += newFreeSpins;
                    document.getElementById('freespins').textContent = freeSpins;
                    showFreeSpinEffect(newFreeSpins);
                } else {
                    showFreeSpinPopup();
                }
                break;
            case '🧧':
                if (isAutoSpin) stopAutoSpin();
                startRedPacketRain();
                break;
            // 其他符号逻辑...
        }

        // 其他中奖逻辑...
    }
}

// 其他函数保持不变（需确保所有更新freeSpins的地方都直接操作全局变量）
// ---------------------

// 示例：红包雨逻辑中更新免费旋转次数
function handleRedPacketClick(packet) {
    const rewardType = Math.random();
    if (rewardType < 0.9) {
        const newFreeSpins = Math.floor(Math.random() * 3) + 1;
        freeSpins += newFreeSpins;
        document.getElementById('freespins').textContent = freeSpins;
    }
    // 其他逻辑...
}