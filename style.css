let balance = 200;
let freeSpins = 0;
let isSpinning = false;
let isAutoSpin = false;
let isFreeSpinActive = false;
let autoSpinInterval;
let missCount = 0;
const symbols = ["ğŸ’°", "ğŸ‰", "â­", "ğŸ’", "ğŸ", "ğŸ§§", "ğŸ°"];
const SPIN_DELAY = 1500; // 1.5ç§’æ—‹è½¬åŠ¨ç”»
const STOP_DELAY = 500;  // æ¯ä¸ªæ ¼å­åœæ­¢é—´éš”

// è®°å½•çº¢åŒ…é›¨ç»“æœ
let redPacketResults = {
    redPackets: 0,
    freeSpins: 0
};

window.addEventListener('load', () => {
    document.getElementById('spinButton').addEventListener('click', startSpin);
    document.getElementById('autoSpinButton').addEventListener('click', toggleAutoSpin);
});

// --- æ ¸å¿ƒä¿®å¤é€»è¾‘ ---
function startFreeSpin() {
    if (freeSpins <= 0) {
        isFreeSpinActive = false;
        return;
    }

    isFreeSpinActive = true;
    startSpin(); // å¼€å§‹æ—‹è½¬
    freeSpins--; // æ¯æ¬¡æ—‹è½¬åå‡å°‘æ¬¡æ•°
    document.getElementById('freespins').textContent = freeSpins;

    // é€’å½’è°ƒç”¨ï¼Œç›´åˆ°å…è´¹æ—‹è½¬æ¬¡æ•°ä¸º0
    setTimeout(() => {
        if (freeSpins > 0) {
            startFreeSpin();
        } else {
            isFreeSpinActive = false;
        }
    }, SPIN_DELAY);
}

function checkWin(results, bet) {
    if (results[0] === results[1] && results[1] === results[2]) {
        const symbol = results[0];
        let winAmount = 0;

        switch (symbol) {
            case 'ğŸ':
                if (isAutoSpin) stopAutoSpin();
                if (isFreeSpinActive) {
                    // å…è´¹æ—‹è½¬ä¸­å†æ¬¡ä¸­å¥–ï¼šç›´æ¥ç´¯åŠ æ¬¡æ•°
                    const newFreeSpins = Math.floor(Math.random() * 5) + 1;
                    freeSpins += newFreeSpins;
                    document.getElementById('freespins').textContent = freeSpins;
                    showFreeSpinEffect(newFreeSpins);
                } else {
                    showFreeSpinPopup();
                }
                break;
            case 'ğŸ§§':
                if (isAutoSpin) stopAutoSpin();
                startRedPacketRain();
                break;
            // å…¶ä»–ç¬¦å·é€»è¾‘...
        }

        // å…¶ä»–ä¸­å¥–é€»è¾‘...
    }
}

// å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆéœ€ç¡®ä¿æ‰€æœ‰æ›´æ–°freeSpinsçš„åœ°æ–¹éƒ½ç›´æ¥æ“ä½œå…¨å±€å˜é‡ï¼‰
// ---------------------

// ç¤ºä¾‹ï¼šçº¢åŒ…é›¨é€»è¾‘ä¸­æ›´æ–°å…è´¹æ—‹è½¬æ¬¡æ•°
function handleRedPacketClick(packet) {
    const rewardType = Math.random();
    if (rewardType < 0.9) {
        const newFreeSpins = Math.floor(Math.random() * 3) + 1;
        freeSpins += newFreeSpins;
        document.getElementById('freespins').textContent = freeSpins;
    }
    // å…¶ä»–é€»è¾‘...
}